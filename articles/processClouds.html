<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="semcloud">
<title>processClouds • semcloud</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="processClouds">
<meta property="og:description" content="semcloud">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">semcloud</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/processClouds.html">processClouds</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="processClouds_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>processClouds</h1>
                        <h4 data-toc-skip class="author">Mariana Montes</h4>
            
            <h4 data-toc-skip class="date">2022-01-19</h4>
      
      
      <div class="d-none name"><code>processClouds.Rmd</code></div>
    </div>

    
    
<p>This package is not autonomous: it is designed to support a specific section of a pipeline, so it assumes the input is the output from the <code>semasioFlow</code> Python package (which uses the <code>qlvl</code> Python package) and prepares the data to be used in <a href="https://github.com/QLVL/NephoVis" class="external-link">NephoVis</a> and the <a href="https://github.com/montesmariana/Level3" class="external-link">Level3 ShinyApp</a>. This vignette will show you how to do that.</p>
<p>First, next to <code>semcloud</code> itself, we will load some packages of the <code>tidyverse</code> and <code>cluster</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://montesmariana.github.io/semcloud">semcloud</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org" class="external-link">purrr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://svn.r-project.org/R-packages/trunk/cluster/" class="external-link">cluster</a></span><span class="op">)</span> <span class="co"># to compute medoids</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/alexcb/rjson" class="external-link">rjson</a></span><span class="op">)</span> <span class="co"># to store json files</span>

<span class="co"># Do not show column types when loading dataframes:</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>readr.show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Then we want to set up the most important paths, which may or may not be in the same directory. By default, the <code>semasioFlow</code> workflow will store some things in an <code>output</code> directory with a <code>tokens</code> subdirectory for token-level matrices and a <code>cws</code> directory for type-level matrices. These are going to be the <strong>input</strong> for this processing. On the other hand, <code>semasioFlow</code> stores registers in a <code>github</code> directory, which you can use to feed data to <code>NephoVis</code>. This is going to be our <strong>output</strong> directory. Each of these will have subdirectories for the different lemmas or concepts you might be working on, even if you only have one. This vignette will first show the code needed to work with only one item, and will offer below loops across many items (lemmas, concepts, whatever).</p>
<div class="section level2">
<h2 id="one-unit-workflow">One unit workflow<a class="anchor" aria-label="anchor" href="#one-unit-workflow"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># based on the directory structure resulting from the Python workflow</span>
<span class="va">lemma</span> <span class="op">&lt;-</span> <span class="st">'name_of_lemma'</span>
<span class="va">base_dir</span> <span class="op">&lt;-</span> <span class="st">"path/to/data"</span> <span class="co"># path for example data</span>
<span class="va">input_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"output"</span>, <span class="st">"tokens"</span>, <span class="va">lemma</span><span class="op">)</span> <span class="co"># where the data is stored</span>
<span class="va">cw_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"output"</span>, <span class="st">"cws"</span>, <span class="va">lemma</span><span class="op">)</span>
<span class="va">output_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"github"</span>, <span class="va">lemma</span><span class="op">)</span> <span class="co"># where the data will go</span></code></pre></div>
<div class="section level3">
<h3 id="token-coordinates">Token coordinates<a class="anchor" aria-label="anchor" href="#token-coordinates"></a>
</h3>
<p>In order to compute the token coordinates, we first need to decide which solutions we are going to choose, that is, whether we are going to run nMDS and, in the case we run t-SNE, which perplexities we are interested in. We might even want to run UMAP (not available yet in this code).</p>
<p>While in the end I mostly looked at t-SNE with perplexity of 30, I will show the instructions when having more options.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># This list works for a loop in the function below and should then be stored as a json file</span>
<span class="co"># in the github directory of each lemma, to tell the visualization what is being used</span>
<span class="va">solutions_old</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"mds"</span> <span class="op">=</span> <span class="st">".mds"</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">perp</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">50</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">solutions_old</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"tsne"</span>, <span class="va">perp</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">".tsne."</span>, <span class="va">perp</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">solutions_old</span></code></pre></div>
<p>Note that the examples have only 60 tokens, so using t-SNE, specially with perplexity of 30, is kind of overkill here. We’ll go for a lower number.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">solutions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"tsne10"</span> <span class="op">=</span> <span class="st">".tsne.10"</span><span class="op">)</span></code></pre></div>
<p>Then we can set up some files and store the solutions mapping.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">suffix</span> <span class="op">&lt;-</span> <span class="st">".ttmx.dist.pac"</span>
<span class="va">models_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">'.models.tsv'</span><span class="op">)</span><span class="op">)</span>
<span class="va">files_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">models_file</span>, lazy <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">`_model`</span>, <span class="va">suffix</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/write.html" class="external-link">write</a></span><span class="op">(</span><span class="fu">rjson</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rjson/man/toJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">solutions</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".solutions.json"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">input_dir</span>, <span class="va">files_list</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The <code><a href="../reference/getClouds.html">semcloud::getClouds()</a></code> function groups the full “workflow”: 1. It sets up one empty dataframe per item in solution, which will be stored in a <code>[lemma].[solution].tsv</code> file.</p>
<ol start="2" style="list-style-type: decimal">
<li>
<p>For each file in <code>files_list</code>:</p>
<p>2.1 It extracts the model name</p>
<p>2.2 It loads the file with <code><a href="../reference/tokensFromPac.html">semcloud::tokensFromPac()</a></code></p>
<p>2.3 If <code>logrank = TRUE</code> (the default), it applies the transformation</p>
<p>2.4 It applies the corresponding algorithm and extracts the coordinates</p>
<p>2.5 It appends the coordinates as columns preceded by the name of the model to the corresponding dataframe</p>
</li>
</ol>
<p>In addition, if “mds” is one of the algorithms, it will <em>return</em> a list with the stress values.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/getClouds.html">getClouds</a></span><span class="op">(</span><span class="va">input_dir</span>, <span class="va">output_dir</span>, <span class="va">files_list</span>, <span class="va">lemma</span>, <span class="va">solutions</span><span class="op">)</span></code></pre></div>
<p>Then you can read your file with <code><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">readr::read_tsv()</a></code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".tsne.10.tsv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="context-words-coordinates">Context words coordinates<a class="anchor" aria-label="anchor" href="#context-words-coordinates"></a>
</h3>
<p>For the context words, the workflow is exactly the same as for the tokens. The difference is that the files are saved as <code>.csv</code> (because for some reason R cannot read them when they are <code>.wwmx...pac</code>) and so it uses the <code><a href="../reference/focdistsFromCsv.html">focdistsFromCsv()</a></code> function.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">suffix</span> <span class="op">&lt;-</span> <span class="st">".wwmx.dist.csv"</span>
<span class="va">files_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">models_file</span><span class="op">)</span><span class="op">$</span><span class="va">`_model`</span>, <span class="va">suffix</span><span class="op">)</span>

<span class="fu"><a href="../reference/getClouds.html">getClouds</a></span><span class="op">(</span><span class="va">cw_dir</span>, <span class="va">output_dir</span>, <span class="va">files_list</span>, <span class="va">lemma</span>, <span class="va">solutions</span>, type <span class="op">=</span> <span class="st">"focdists"</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-distances-and-coordinates">Model distances and coordinates<a class="anchor" aria-label="anchor" href="#model-distances-and-coordinates"></a>
</h3>
<p>The function belows loads the <code>[lemma].models.tsv</code> file in the <code>output_dir</code> in order to modify it by appending the coordinates from an nMDS on the distances between the models. By default, it will compute “euclidean” distances on the transformed matrices, but the function can be changed with the <code>fun</code> argument, and the transformation can be turned off with the <code>transformed</code> argument. It returns some data for a register (which I tend to combine across lemmas and store as <code>euclidean_register.tsv</code> to tell the index of the visualization which lemmas to offer :)</p>
<p>Under the hood, it also stores the distance matrix as <code>[lemma].models.dist.tsv</code>. If the file already exists, it loads it instead of recomputing the distances.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compLemma.html">compLemma</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="va">input_dir</span>, <span class="va">output_dir</span><span class="op">)</span></code></pre></div>
<p>The output is a <code><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble::tibble()</a></code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">reg</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="medoids">Medoids<a class="anchor" aria-label="anchor" href="#medoids"></a>
</h3>
<p>The medoids are simply calculated with <code><a href="https://rdrr.io/pkg/cluster/man/pam.html" class="external-link">cluster::pam()</a></code> and some basic information is stored in a <code>[lemma].medoids.tsv</code> file. The only important column for the visualization is <code>medoids</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">8</span> <span class="co"># number of medoids you want</span>
<span class="va">distmtx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".models.dist.tsv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/matricizeCloud.html">matricizeCloud</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">as.dist</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">pam_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/cluster/man/pam.html" class="external-link">pam</a></span><span class="op">(</span><span class="va">distmtx</span>, k <span class="op">=</span> <span class="va">k</span><span class="op">)</span>
<span class="va">medoid_data</span> <span class="op">&lt;-</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">clusinfo</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>medoids <span class="op">=</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">medoids</span>, medoid_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">k</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">medoid_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".medoids.tsv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">medoid_data</span></code></pre></div>
<p>We can also add the clustering information to the models register.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">models_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".models.tsv"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">models_file</span>, lazy<span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
        pam_cluster <span class="op">=</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">clustering</span><span class="op">[</span><span class="va">`_model`</span><span class="op">]</span>, <span class="co"># add pam-cluster number</span>
        medoid <span class="op">=</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">medoids</span><span class="op">[</span><span class="va">pam_cluster</span><span class="op">]</span> <span class="co"># add name of medoid</span>
    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">models_file</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="hdbscan">HDBSCAN<a class="anchor" aria-label="anchor" href="#hdbscan"></a>
</h3>
<p>I’ve mostly computed HDBSCAN among the medoids, but it could certainly be computed for all models. HDBSCAN information, from clustering to membership probabilities or eps, <em>could</em> in principle be included for NephoVis, but I haven’t done it because the result varies per model, meaning that each token will have about 200 columns for each of them (or 8 if it’s only with the medoids, which it’s still a lot), and that is hard to incorporate into the tool.</p>
<p>Instead, I work with an RDS file with a list of models per lemma, and each model object includes:</p>
<ul>
<li>coordinates: the coordinates from t-SNE with perplexity 30, next to other variables in the “variables” dataframe like, in my case, “senses”, as well as the tailored list of context words. We add the token-wise HDBSCAN info here</li>
<li>cws: distribution of first-order context words across HDBSCAN clusters and their t-SNE coordinates if available</li>
<li>(optionally) the normal HDBSCAN plot</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># You could run it on all the models or just the medoids</span>
<span class="co"># models &lt;- read_tsv(file.path(output_dir, lpaste0(lemma, ".models.tsv")))$`_model` # all models</span>
<span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".medoids.tsv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">medoids</span> <span class="co"># only medoids</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">models</span>, <span class="va">models</span><span class="op">)</span>,
           <span class="va">summarizeHDBSCAN</span>, lemma <span class="op">=</span> <span class="va">lemma</span>,
           input_dir <span class="op">=</span> <span class="va">input_dir</span>,
           output_dir <span class="op">=</span> <span class="va">output_dir</span>,
           coords_name <span class="op">=</span> <span class="st">'.tsne.10'</span><span class="op">)</span>

<span class="co"># I would normally make one of these files for all my lemmas and store it within the github directory above the lemma subdirectories</span>
<span class="va">to_write</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">to_write</span><span class="op">[</span><span class="va">lemma</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">res</span>
<span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">write_rds</a></span><span class="op">(</span><span class="va">to_write</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"hdbscan.rds"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The output has a named list of models:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></code></pre></div>
<p>Each of them has a <code>coords</code> element with data per token:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">coords</span></code></pre></div>
<p>Next to it, there is a <code>cws</code> element with data per context word per cluster; if there are no coordinates, they all become zeros:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">cws</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="loops-across-multiple-lemmas">Loops across multiple lemmas<a class="anchor" aria-label="anchor" href="#loops-across-multiple-lemmas"></a>
</h2>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lemmas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'lemma1'</span>, <span class="st">'lemma2'</span>, <span class="st">'lemma3'</span><span class="op">)</span> <span class="co">#or whatever they are</span>
<span class="va">base_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span><span class="op">)</span> <span class="co"># path for example data</span>
<span class="va">input_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"output"</span>, <span class="st">"tokens"</span><span class="op">)</span> <span class="co"># where the data is stored</span>
<span class="va">cw_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"output"</span>, <span class="st">"cws"</span><span class="op">)</span>
<span class="va">output_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"github"</span><span class="op">)</span> <span class="co"># where the data will go</span>
<span class="va">solutions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"tsne30"</span> <span class="op">=</span> <span class="st">".tsne.30"</span><span class="op">)</span>

<span class="co"># Token level ----</span>
<span class="va">suffix</span> <span class="op">&lt;-</span> <span class="st">".ttmx.dist.pac"</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">lemma</span> <span class="kw">in</span> <span class="va">lemmas</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">models_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">'.models.tsv'</span><span class="op">)</span><span class="op">)</span>
  <span class="va">files_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">models_file</span>, lazy <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">`_model`</span>, <span class="va">suffix</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/write.html" class="external-link">write</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/rjson/man/toJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">solutions</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".solutions.json"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="../reference/getClouds.html">getClouds</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">input_dir</span>, <span class="va">lemma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span><span class="op">)</span>, <span class="va">files_list</span>, <span class="va">lemma</span>, <span class="va">solutions</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Context words level ----</span>

<span class="va">suffix</span> <span class="op">&lt;-</span> <span class="st">".wwmx.dist.csv"</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">lemma</span> <span class="kw">in</span> <span class="va">lemmas</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">models_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">'.models.tsv'</span><span class="op">)</span><span class="op">)</span>
  <span class="va">files_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">models_file</span>, lazy <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">`_model`</span>, <span class="va">suffix</span><span class="op">)</span>
  <span class="fu"><a href="../reference/getClouds.html">getClouds</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cw_dir</span>, <span class="va">lemma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span><span class="op">)</span>, <span class="va">files_list</span>, <span class="va">lemma</span>, <span class="va">solutions</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Distances between models ----</span>
<span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">lemmas</span>, <span class="op">~</span><span class="fu"><a href="../reference/compLemma.html">compLemma</a></span><span class="op">(</span><span class="va">.x</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">input_dir</span>, <span class="va">.x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">reg</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"euclidean_register.tsv"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Medoids ----</span>

<span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">8</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">lemma</span> <span class="kw">in</span> <span class="va">lemmas</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">distmtx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".models.dist.tsv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="../reference/matricizeCloud.html">matricizeCloud</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">as.dist</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">pam_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/cluster/man/pam.html" class="external-link">pam</a></span><span class="op">(</span><span class="va">distmtx</span>, k <span class="op">=</span> <span class="va">k</span><span class="op">)</span>
  <span class="va">medoid_data</span> <span class="op">&lt;-</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">clusinfo</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>medoids <span class="op">=</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">medoids</span>, medoid_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">k</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">medoid_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".medoids.tsv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="va">models_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".models.tsv"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">models_file</span>, lazy <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
      pam_cluster <span class="op">=</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">clustering</span><span class="op">[</span><span class="va">`_model`</span><span class="op">]</span>, <span class="co"># add pam-cluster number</span>
      medoid <span class="op">=</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">medoids</span><span class="op">[</span><span class="va">pam_cluster</span><span class="op">]</span> <span class="co"># add name of medoid</span>
      <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">models_file</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># HDBSCAN ----</span>
<span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">lemmas</span>, <span class="va">lemmas</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">lemma</span><span class="op">)</span><span class="op">{</span>
  <span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".medoids.tsv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">medoids</span> <span class="co"># only medoids</span>
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">models</span>, <span class="va">models</span><span class="op">)</span>,
      <span class="va">summarizeHDBSCAN</span>, lemma <span class="op">=</span> <span class="va">lemma</span>,
      input_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">input_dir</span>, <span class="va">lemma</span><span class="op">)</span>,
      output_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">write_rds</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"hdbscan.rds"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Mariana Montes.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
