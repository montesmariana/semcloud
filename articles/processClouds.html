<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="semcloud">
<title>From semasioFlow to NephoVis • semcloud</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="From semasioFlow to NephoVis">
<meta property="og:description" content="semcloud">
<meta property="og:image" content="https://montesmariana.github.io/semcloud/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">semcloud</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/processClouds.html">From SemasioFlow to NephoVis</a>
    <a class="dropdown-item" href="../articles/weightConcordance.html">Weight contexts</a>
    <a class="dropdown-item" href="../articles/HDBSCAN.html">HDBSCAN in token-level clouds</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/montesmariana/semcloud/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="processClouds_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>From semasioFlow to NephoVis</h1>
                        <h4 data-toc-skip class="author">Mariana Montes</h4>
            
            <h4 data-toc-skip class="date">2022-04-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/montesmariana/semcloud/blob/HEAD/vignettes/processClouds.Rmd" class="external-link"><code>vignettes/processClouds.Rmd</code></a></small>
      <div class="d-none name"><code>processClouds.Rmd</code></div>
    </div>

    
    
<p>This package is not autonomous: it is designed to support a specific section of a pipeline, meaning that it takes as input output from the <a href="https://montesmariana.github.io/semasioFlow" class="external-link"><code>semasioFlow</code></a> Python package<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;A similar vignette for the Python steps can be found &lt;a href="https://montesmariana.github.io/semasioFlow/tutorials/createClouds.html" class="external-link"&gt;here&lt;/a&gt;.&lt;/p&gt;'><sup>1</sup></a> and prepares the data to be used in <a href="https://qlvl.github.io/NephoVis" class="external-link">NephoVis</a> and the <a href="https://github.com/montesmariana/Level3" class="external-link">Level3 ShinyApp</a>. This vignette will show the procedure to prepare data for NephoVis, whereas <code><a href="../articles/HDBSCAN.html">vignette('HDBSCAN')</a></code> will go through the HDBSCAN clustering for Level3 and the classification of clouds.</p>
<p>First, next to <code>semcloud</code> itself, we will load some packages of the <code>tidyverse</code> and <code>cluster</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://montesmariana.github.io/semcloud">semcloud</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org" class="external-link">purrr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://svn.r-project.org/R-packages/trunk/cluster/" class="external-link">cluster</a></span><span class="op">)</span> <span class="co"># to compute medoids</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/alexcb/rjson" class="external-link">rjson</a></span><span class="op">)</span> <span class="co"># to store json files</span>

<span class="co"># Do not show column types when loading dataframes:</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>readr.show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Then we want to set up the most important paths, which may or may not be in the same directory. By default, the <a href="https://montesmariana.github.io/semasioFlow/tutorials/createClouds.html" class="external-link"><code>semasioFlow</code> workflow</a> will store the distance matrices in an <code>output</code> directory with a <code>tokens</code> subdirectory for token-level matrices and a <code>cws</code> directory for type-level matrices. These are going to be the <strong>input</strong> for this processing. On the other hand, <code>semasioFlow</code> stores registers (frequency data of the context words, parameter settings of the different models and lists of context words per token) in a <code>nephovis</code> directory, which you can use to feed data to <a href="https://github.com/qlvl/nephovis" class="external-link">NephoVis</a>. This is going to be our <strong>output</strong> directory. Each of these will have subdirectories for the different lemmas or concepts you might be working on, even if you only have one. For a semasiological workflow <span class="citation">(e.g. Montes 2021)</span> you will use lemmas, whereas an onomasiological workflow <span class="citation">(e.g. Montes, Franco, and Heylen 2021)</span> you will use concepts; the only difference is that the latter combines different variants per model. Any mention of lemmas in this vignette can be substituted for <em>concept</em> in the onomasiological workflow.</p>
<p>First we will look at the different steps when working with one lemma and then sum up with a loop over multiple lemmas.</p>
<div class="section level2">
<h2 id="single-lemma-workflow">Single lemma workflow<a class="anchor" aria-label="anchor" href="#single-lemma-workflow"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># based on the directory structure resulting from the Python workflow</span>
<span class="va">lemma</span> <span class="op">&lt;-</span> <span class="st">'name_of_lemma'</span>
<span class="va">base_dir</span> <span class="op">&lt;-</span> <span class="st">"path/to/data"</span> <span class="co"># shared path</span>
<span class="va">input_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"output"</span>, <span class="st">"tokens"</span>, <span class="va">lemma</span><span class="op">)</span> <span class="co"># where the data is stored</span>
<span class="va">cw_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"output"</span>, <span class="st">"cws"</span>, <span class="va">lemma</span><span class="op">)</span>
<span class="va">output_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"nephovis"</span>, <span class="va">lemma</span><span class="op">)</span> <span class="co"># where the data will go</span></code></pre></div>
<div class="section level3">
<h3 id="token-coordinates">Token coordinates<a class="anchor" aria-label="anchor" href="#token-coordinates"></a>
</h3>
<p>The first step is to go through the token-level distance matrices and apply dimensionality reduction to obtain only two coordinates for visualization. For that purpose we need to decide which methods we are interested in (in case we want to compare them). The options are:</p>
<ul>
<li><p><code>'mds'</code>: nonmetric multidimensional scaling (ran with <code><a href="https://rdrr.io/pkg/vegan/man/metaMDS.html" class="external-link">vegan::metaMDS()</a></code>)</p></li>
<li><p><code>'tsne'</code>: t-stochastic neighbor embedding (ran with <code><a href="https://rdrr.io/pkg/Rtsne/man/Rtsne.html" class="external-link">Rtsne::Rtsne()</a></code>), with different perplexities indicated by appending a number to the label, e.g. <code>'tsne20'</code>, <code>'tsne30'</code>…</p></li>
<li><p><code>'umap'</code>: uniform manifold approximation and projection (ran with <code><a href="https://rdrr.io/pkg/umap/man/umap.html" class="external-link">umap::umap()</a></code>).</p></li>
</ul>
<p>For each technique, we obtain a different solution, which results in a tab-separated file with one row per token, a column with IDs and two columns per model: the x and the y coordinates. A named list as shown below will inform the code of which techniques to use (the names in the list) and which infixes to use in the file names.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># This list works for a loop in the function below and should then be stored as a json file</span>
<span class="co"># in the github directory of each lemma, to tell the visualization what is being used</span>
<span class="va">solutions_old</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"mds"</span> <span class="op">=</span> <span class="st">".mds"</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">perp</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">50</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">solutions_old</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"tsne"</span>, <span class="va">perp</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">".tsne."</span>, <span class="va">perp</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">solutions_old</span></code></pre></div>
<p>For example, the code line below will only run <code><a href="https://rdrr.io/pkg/Rtsne/man/Rtsne.html" class="external-link">Rtsne::Rtsne()</a></code> with perplexity 30 and store the coordinates in a file called <code>'name_of_lemma.tsne.30.tsv'</code>. This list must also be stored, to inform NephoVis of the available visualization options and how to find their data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">solutions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"tsne30"</span> <span class="op">=</span> <span class="st">".tsne.30"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/write.html" class="external-link">write</a></span><span class="op">(</span><span class="fu">rjson</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rjson/man/toJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">solutions</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".solutions.json"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We also need a list of filenames to obtain the distances from, which we could either read by filtering the contents of our <code>output_dir</code> or by appending the file extension to the names of the models in our register.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">suffix</span> <span class="op">&lt;-</span> <span class="st">".ttmx.dist.pac"</span>
<span class="va">models_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">'.models.tsv'</span><span class="op">)</span><span class="op">)</span>
<span class="va">files_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">models_file</span><span class="op">)</span><span class="op">$</span><span class="va">`_model`</span>, <span class="va">suffix</span><span class="op">)</span></code></pre></div>
<p>The <code><a href="../reference/getClouds.html">getClouds()</a></code> function groups the full “workflow”:</p>
<ol style="list-style-type: decimal">
<li><p>It sets up one empty dataframe per item in <code>solutions</code>, which will be filled in with coordinates and stored in a <code>'[lemma].[solution].tsv'</code> file.</p></li>
<li>
<p>For each file in <code>files_list</code>:</p>
<p>2.1 It extracts the model name</p>
<p>2.2 It loads the file with <code><a href="../reference/tokensFromPac.html">tokensFromPac()</a></code></p>
<p>2.3 If <code>logrank = TRUE</code> (the default), it applies the transformation; if <code>logdist = TRUE</code> it also <em>computes</em> euclidean distances on the log-transformed values instead of just making them symmetric. The clouds in <a href="https://cloudspotting.marianamontes.me" class="external-link"><em>Cloudspotting</em></a> were generated with <code>logrank = TRUE, logdist = FALSE</code>.</p>
<p>2.4 It applies the corresponding algorithm and extracts the coordinates</p>
<p>2.5 It appends the coordinates as columns preceded by the name of the model to the corresponding dataframe: <code>'[modelname].x'</code>; <code>'[modelname].y'</code>.</p>
</li>
</ol>
<p>In addition, if “mds” is one of the algorithms, it will <em>return</em> a list with the stress values.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/getClouds.html">getClouds</a></span><span class="op">(</span><span class="va">input_dir</span>, <span class="va">output_dir</span>, <span class="va">files_list</span>, <span class="va">lemma</span>, <span class="va">solutions</span><span class="op">)</span></code></pre></div>
<p>Then you can read your files with <code><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">readr::read_tsv()</a></code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".tsne.30.tsv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="context-words-coordinates">Context words coordinates<a class="anchor" aria-label="anchor" href="#context-words-coordinates"></a>
</h3>
<p>For the context words, the workflow is exactly the same as for the tokens. The difference is that the files are saved as <code>'.csv'</code> (because for some reason R cannot read them when they are <code>.wwmx...pac</code>) and so it uses the <code><a href="../reference/focdistsFromCsv.html">focdistsFromCsv()</a></code> function. This is indicated by specifying <code>type = "focdists"</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">suffix</span> <span class="op">&lt;-</span> <span class="st">".wwmx.dist.csv"</span>
<span class="va">files_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">models_file</span><span class="op">)</span><span class="op">$</span><span class="va">`_model`</span>, <span class="va">suffix</span><span class="op">)</span>

<span class="fu"><a href="../reference/getClouds.html">getClouds</a></span><span class="op">(</span><span class="va">cw_dir</span>, <span class="va">output_dir</span>, <span class="va">files_list</span>, <span class="va">lemma</span>, <span class="va">solutions</span>, type <span class="op">=</span> <span class="st">"focdists"</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-distances-and-coordinates">Model distances and coordinates<a class="anchor" aria-label="anchor" href="#model-distances-and-coordinates"></a>
</h3>
<p>The files created by <code><a href="../reference/getClouds.html">getClouds()</a></code> take care of the visualization in Levels 2 and 3 of NephoVis. For the Level 1 plot, as well as the distance matrix in Level 2 and the selection of medoids, we first need to obtain distances between the models. For that purpose, <code><a href="../reference/compLemma.html">compLemma()</a></code> loads the <code>'[lemma].models.tsv'</code> file in the <code>output_dir</code> in order to modify it by appending the coordinates from <code><a href="https://rdrr.io/pkg/vegan/man/metaMDS.html" class="external-link">vegan::metaMDS()</a></code> on the distances between the models. By default, it will compute “euclidean” distances on the transformed matrices (see <code><a href="../reference/eucliMats.html">eucliMats()</a></code>), but the function can be changed with the <code>fun</code> argument, and the transformation can be turned off with the <code>transformed</code> argument. It returns some data for a register, which I tend to combine across lemmas and store as <code>euclidean_register.tsv</code> to tell the index of the visualization which lemmas to offer.</p>
<p>Under the hood, it also stores the distance matrix as <code>[lemma].models.dist.tsv</code>. If the file already exists, it loads it instead of recomputing the distances. This distance matrix is then used in Level 2 of NephoVis.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compLemma.html">compLemma</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="va">input_dir</span>, <span class="va">output_dir</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="medoids">Medoids<a class="anchor" aria-label="anchor" href="#medoids"></a>
</h3>
<p>The medoids are simply calculated with <code><a href="https://rdrr.io/pkg/cluster/man/pam.html" class="external-link">cluster::pam()</a></code> and some basic information is stored in a <code>[lemma].medoids.tsv</code> file. The only important column for the visualization is <code>medoids</code>, which is what NephoVis reads to automatically select the right models.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">8</span> <span class="co"># number of medoids you want</span>

<span class="va">distmtx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".models.dist.tsv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/matricizeCloud.html">matricizeCloud</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">as.dist</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">pam_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/cluster/man/pam.html" class="external-link">pam</a></span><span class="op">(</span><span class="va">distmtx</span>, k <span class="op">=</span> <span class="va">k</span><span class="op">)</span>
<span class="va">medoid_data</span> <span class="op">&lt;-</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">clusinfo</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>medoids <span class="op">=</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">medoids</span>, medoid_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">k</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">medoid_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".medoids.tsv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We can also add the clustering information to the models register.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">models_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".models.tsv"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">models_file</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
        pam_cluster <span class="op">=</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">clustering</span><span class="op">[</span><span class="va">`_model`</span><span class="op">]</span>, <span class="co"># add pam-cluster number</span>
        medoid <span class="op">=</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">medoids</span><span class="op">[</span><span class="va">pam_cluster</span><span class="op">]</span> <span class="co"># add name of medoid</span>
    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">models_file</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="further-steps">Further steps<a class="anchor" aria-label="anchor" href="#further-steps"></a>
</h3>
<p>The visualization can also take advantage of tailored contexts for the different models; the code to obtain these columns, based on the output of <a href="https://montesmariana.github.io/semasioFlow/semasioFlow.contextwords.html#semasioFlow.contextwords.listContextwords" class="external-link"><code>semasioFlow.contextwords.listContextwords()</code></a> and the data in <code>'[lemma].variables.tsv'</code>, is described in <code><a href="../articles/weightConcordance.html">vignette('weightConcordance')</a></code>.</p>
<p>In addition, HDBSCAN clustering and classification of the clusters is covered in <code><a href="../articles/HDBSCAN.html">vignette('HDBSCAN')</a></code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="loops-across-multiple-lemmas">Loops across multiple lemmas<a class="anchor" aria-label="anchor" href="#loops-across-multiple-lemmas"></a>
</h2>
<p>Below is some code to run the workflow above across multiple lemmas.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lemmas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'lemma1'</span>, <span class="st">'lemma2'</span>, <span class="st">'lemma3'</span><span class="op">)</span> <span class="co">#or whatever they are</span>
<span class="va">base_dir</span> <span class="op">&lt;-</span> <span class="st">'/path/to/data'</span>
<span class="va">input_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"output"</span>, <span class="st">"tokens"</span><span class="op">)</span> <span class="co"># where the data is stored</span>
<span class="va">cw_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"output"</span>, <span class="st">"cws"</span><span class="op">)</span>
<span class="va">output_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">base_dir</span>, <span class="st">"nephovis"</span><span class="op">)</span> <span class="co"># where the data will go</span>
<span class="va">solutions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"tsne30"</span> <span class="op">=</span> <span class="st">".tsne.30"</span><span class="op">)</span>

<span class="co"># Token level ----</span>
<span class="va">suffix</span> <span class="op">&lt;-</span> <span class="st">".ttmx.dist.pac"</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">lemma</span> <span class="kw">in</span> <span class="va">lemmas</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">models_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">'.models.tsv'</span><span class="op">)</span><span class="op">)</span>
  <span class="va">files_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">models_file</span><span class="op">)</span><span class="op">$</span><span class="va">`_model`</span>, <span class="va">suffix</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/write.html" class="external-link">write</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/rjson/man/toJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">solutions</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".solutions.json"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="../reference/getClouds.html">getClouds</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">input_dir</span>, <span class="va">lemma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span><span class="op">)</span>, <span class="va">files_list</span>, <span class="va">lemma</span>, <span class="va">solutions</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Context words level ----</span>

<span class="va">suffix</span> <span class="op">&lt;-</span> <span class="st">".wwmx.dist.csv"</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">lemma</span> <span class="kw">in</span> <span class="va">lemmas</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">models_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">'.models.tsv'</span><span class="op">)</span><span class="op">)</span>
  <span class="va">files_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">models_file</span><span class="op">)</span><span class="op">$</span><span class="va">`_model`</span>, <span class="va">suffix</span><span class="op">)</span>
  <span class="fu"><a href="../reference/getClouds.html">getClouds</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cw_dir</span>, <span class="va">lemma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span><span class="op">)</span>, <span class="va">files_list</span>, <span class="va">lemma</span>, <span class="va">solutions</span>,
            type <span class="op">=</span> <span class="st">'focdists'</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Distances between models ----</span>
<span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">lemmas</span>, <span class="op">~</span><span class="fu"><a href="../reference/compLemma.html">compLemma</a></span><span class="op">(</span><span class="va">.x</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">input_dir</span>, <span class="va">.x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">reg</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"euclidean_register.tsv"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Medoids ----</span>

<span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">8</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">lemma</span> <span class="kw">in</span> <span class="va">lemmas</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">distmtx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".models.dist.tsv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="../reference/matricizeCloud.html">matricizeCloud</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">as.dist</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">pam_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/cluster/man/pam.html" class="external-link">pam</a></span><span class="op">(</span><span class="va">distmtx</span>, k <span class="op">=</span> <span class="va">k</span><span class="op">)</span>
  <span class="va">medoid_data</span> <span class="op">&lt;-</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">clusinfo</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>medoids <span class="op">=</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">medoids</span>, medoid_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">k</span><span class="op">)</span><span class="op">)</span>
  
  <span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">medoid_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".medoids.tsv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">models_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="va">lemma</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">lemma</span>, <span class="st">".models.tsv"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="va">models_file</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
      pam_cluster <span class="op">=</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">clustering</span><span class="op">[</span><span class="va">`_model`</span><span class="op">]</span>, <span class="co"># add pam-cluster number</span>
      medoid <span class="op">=</span> <span class="va">pam_data</span><span class="op">$</span><span class="va">medoids</span><span class="op">[</span><span class="va">pam_cluster</span><span class="op">]</span> <span class="co"># add name of medoid</span>
      <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">models_file</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references">
<div id="ref-montes_2021">
<p>Montes, Mariana. 2021. “Cloudspotting: Visual Analytics for Distributional Semantics.” PhD thesis, Leuven: KU Leuven.</p>
</div>
<div id="ref-montes.etal_2021">
<p>Montes, Mariana, Karlien Franco, and Kris Heylen. 2021. “Indestructible Insights. A Case Study in Distributional Prototype Semantics.” In <em>Cognitive Sociolinguistics Revisited</em>, edited by Gitte Kristiansen, Karlien Franco, Stefano De Pascale, Laura Rosseel, and Weiwei Zhang, 251–63. De Gruyter. <a href="https://doi.org/10.1515/9783110733945-021" class="external-link">https://doi.org/10.1515/9783110733945-021</a>.</p>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Mariana Montes.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
